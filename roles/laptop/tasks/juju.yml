---

- name: make go path
  file: path=~/dev/go state=link src=/opt/go

- name: get go tools
  command: go get {{item.src}}
  args:
    creates: ~/dev/go/bin/{{item.bin}}
  with_items:
    - {src: github.com/rogpeppe/godeps, bin: godeps}
    - {src: github.com/rogpeppe/godef, bin: godef}
    - {src: golang.org/x/tools/cmd/guru, bin: guru}
    - {src: golang.org/x/tools/cmd/gorename, bin: gorename}
    - {src: github.com/nsf/gocode, bin: gocode}
    - {src: github.com/github/hub, bin: hub}

- name: get juju source
  command: go get -d github.com/juju/juju/...
  ignore_errors: yes
  # For some reason, it complains about (I think) pinned dependencies between azure-sdk-for-go and go-autorest.

- name: update godeps
  command: godeps -u dependencies.tsv
  args:
    chdir: ~/dev/go/src/github.com/juju/juju

- name: get juju source
  command: go get -d github.com/juju/juju/...
  # There's bound to be a better way to do this.

- name: install juju dependencies
  command: make install-dependencies
  args:
    chdir: ~/dev/go/src/github.com/juju/juju

- name: install juju
  command: go install github.com/juju/juju/...
  args:
    creates: ~/dev/go/bin/juju

- name: switch origin to my fork
  command: git remote set-url origin git@github.com:babbageclunk/juju.git
  args:
    chdir: ~/dev/go/src/github.com/juju/juju

- name: list remotes
  command: git remote -v
  args:
    chdir: ~/dev/go/src/github.com/juju/juju
  register: juju_remotes

- name: maybe add upstream repo
  command: git remote add upstream https://github.com/juju/juju.git
  when: juju_remotes.stdout.find('upstream') == -1
  args:
    chdir: ~/dev/go/src/github.com/juju/juju

- name: add pre-push hook
  file:
    src: ~/dev/go/src/github.com/juju/juju/scripts/pre-push.bash
    dest: ~/dev/go/src/github.com/juju/juju/.git/hooks/pre-push
    state: link

- name: make juju link dir
  file: src=~/dev/go/src/github.com/juju/juju dest=~/juju state=link

- name: get kvm-setup utils
  git: repo={{item.repo}} dest={{item.dest}}
  with_items:
    -
      repo: git@github.com:babbageclunk/ubuntu-fan-hacks.git
      dest: ~/dev/ubuntu-fan-hacks
    -
      repo: https://github.com/frobware/kvm-maas.git
      dest: ~/dev/kvm-maas

# - name: CI tools
#   bzr: name=lp:{{item.repo}} dest=~/dev/{{item.dest}}
#   with_items:
#     - {repo: juju-ci-tools, dest: juju-ci-tools}
#     - {repo: juju-ci-tools/repository, dest: repository}
#     - {repo: ~juju-qa/+junk/cloud-city, dest: cloud-city}
